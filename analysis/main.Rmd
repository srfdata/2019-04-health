---
title: "2019-04-health"
author: "SRF Data, Felix Michel (felix.michel@srf.ch)"
date: "April 2019"
output:
  html_document:
    code_folding: show
    echo: TRUE
    warning: FALSE
    message: FALSE
    theme: simplex
    df_print: kable
    toc: yes
    toc_depth: 4
    toc_float: 
      collapsed: false
      smooth_scroll: false
subtitle: Vorprozessierung und Analyse
---

```{r, echo=FALSE}
# CONFIG
user_name <- "srfdata" # github user name
project_name <- "2019-04-health" # adapt to new repo name
package_date <- "2019-03-01" # date of the CRAN snapshot that
# the checkpoint package uses
R_version <- "3.5.3" # R-Version to use
options(Ncpus = 4) # use 4 cores for parallelized installation of packages
if (R_version != paste0(version$major, ".", version$minor)){
  stop("ERROR: specified R version does not match currently used.")
}
```

## Vorbemerkungen

Dieses Dokument beschreibt die Vorprozessierung und explorative Analyse des Datensatzes, der Grundlage des auf srf.ch veröffentlichten Artikels [Wie gesund ist die Schweiz](http://www.srf.ch/data) ist.

SRF Data legt Wert darauf, dass die Datenvorprozessierung und -Analyse nachvollzogen und überprüft werden kann. SRF Data glaubt an das Prinzip offener Daten, aber auch offener und nachvollziehbarer Methoden. Zum anderen soll es Dritten ermöglicht werden, auf dieser Vorarbeit aufzubauen und damit weitere Auswertungen oder Applikationen zu generieren.

Die Endprodukte des vorliegenden Scripts, neben der explorativen Analyse, sind (Datenbeschreibung siehe unten):

* `health_survey_2017.csv`: Datensatz Gesundheitsbefragung reduziert auf 17 Kategorien als CSV
* `health_survey_2017.json`: Datensatz Gesundheitsbefragung reduziert auf 11 Kategorien als JSON

### R-Script & Daten

Die Vorprozessierung und Analyse wurde im Statistikprogramm R vorgenommen. Das zugrunde liegende Script sowie die prozessierten Daten können unter [diesem Link](https://srfdata.github.io/`r project_name`/rscript.zip) heruntergeladen werden. Durch Ausführen von `main.Rmd` kann der hier beschriebene Prozess nachvollzogen und der für den Artikel verwendete Datensatz generiert werden. Dabei werden Daten aus dem Ordner `input` eingelesen und Ergebnisse in den Ordner `output` geschrieben. 

SRF Data verwendet das [rddj-template](https://github.com/grssnbchr/rddj-template) von Timo Grossenbacher als Grundlage für seine R-Scripts. Entstehen bei der Ausführung dieses Scripts Probleme, kann es helfen, die Anleitung von [rddj-template](https://github.com/grssnbchr/rddj-template) zu studieren.

Debug-Informationen: *This report was generated on `r Sys.time()`. R version: `r paste0(version$major, ".", version$minor)` on `r version$platform`. For this report, CRAN packages as of `r package_date` were used.*

### GitHub

Der Code für die vorliegende Datenprozessierung ist auf [https://github.com/srfdata/`r project_name`](https://github.com/srfdata/`r project_name`) zur freien Verwendung verfügbar. 

### Lizenz

<a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons Lizenzvertrag" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png" /></a><br /><span xmlns:dct="http://purl.org/dc/terms/" href="http://purl.org/dc/dcmitype/Dataset" property="dct:title" rel="dct:type">`r project_name`</span> von <a xmlns:cc="http://creativecommons.org/ns#" href="https://github.com/srfdata/`r project_name`" property="cc:attributionName" rel="cc:attributionURL">SRF Data</a> ist lizenziert unter einer <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Namensnennung - Weitergabe unter gleichen Bedingungen 4.0 International Lizenz</a>.

### Weitere Projekte

Code & Daten von [SRF Data](http://srf.ch/data) sind unter [http://srfdata.github.io](http://srfdata.github.io) verfügbar.

### Haftungsausschluss

Die veröffentlichten Informationen sind sorgfältig zusammengestellt, erheben aber keinen Anspruch auf Aktualität, Vollständigkeit oder Richtigkeit. Es wird keine Haftung übernommen für Schäden, die  durch die Verwendung dieses Scripts oder der daraus gezogenen Informationen entstehen. Dies gilt ebenfalls für Inhalte Dritter, die über dieses Angebot zugänglich sind.

### Datenbeschreibung 

#### `health_survey_2017.json`, `health_survey_2017.csv`

| Attribut | Typ | Beschreibung |
|-------|------|-----------------------------------------------------------------------------|
| group | String | Einteilung nach Geschlecht: Männer, Frauen |
| subgroup | String  | Einteilung nach Altersgruppe |
| category | String | Kategoriebezeichnung in Englisch des ausgewählten Gesundheitsthemas |
| year  | String | Erhebungsjahr der Gesundheitsbefragung |
| key  | String | Antwortmöglichkeit, unterschiedlich je nach Thema |
| value  | Numeric | Entsprechender Wert für key |

### Originalquelle

#### Standardtabellen Gesundheitsbefragung 2017

&rarr; `input/tabellen_2017`

Die Daten stammen aus der [Schweizerischen Gesundheitsbefragung](https://www.bfs.admin.ch/bfs/de/home/statistiken/gesundheit/erhebungen/sgb.html), die alle fünf Jahre seit 1992 durchgeführt wird. Die sechste Erhebung fand im Jahr 2017 statt und wurde Ende Februar 2019 publiziert. Für das vorliegende Projekt wurden die Standardtabellen 2017 verwendet. Insgesamt hat das BfS 86 Tabellen veröffentlicht. Es handelt sich dabei um Excel-Dateien, die auf den jeweiligen Sheets die Daten der vergangenen Erhebungen enthalten. Die Tabellen können beim [Bundesamt für Statistik (BfS)](https://www.bfs.admin.ch/bfs/de/home/statistiken/kataloge-datenbanken/tabellen.html?dyn_prodima=900210) heruntergeladen werden können.

Jede Tabelle enthält die Daten für ein Gesundheitsthema (zum Beispiel: Wie häufig trinken Sie normalerweise alkoholische Getränke?). Die Antwortmöglichkeiten (key) unterscheiden sich je nach Thema. In den Tabellen sind die Daten nach Sprachregion, Bildungshintergrund, Geschlecht und Alter unterschieden.

#### Glossar 2017

&rarr; `input/gesundheitsbefragung_glossar_2017.csv`

Mit Hilfe des Glossar werden die Tabellen ausgewählt, die in diesem Skript analysiert wurden. Im Glossar sind der Dateiname der Tabelle, die englische Kategoriebezeichnung und die unterschiedlichen Antwortmöglichkeiten enthalten.

## Vorbereitungen

```{r preparations, echo=FALSE}
detach_all_packages <- function() {
  basic_packages_blank <-  c("stats",
                             "graphics",
                             "grDevices",
                             "utils",
                             "datasets",
                             "methods",
                             "base")
  basic_packages <- paste("package:", basic_packages_blank, sep = "")

  package_list <- search()[
    ifelse(unlist(gregexpr("package:", search())) == 1, TRUE, FALSE)]

  package_list <- setdiff(package_list, basic_packages)

  if (length(package_list) > 0)  for (package in package_list) {
    detach(package, character.only = TRUE, unload = TRUE)
    print(paste("package ", package, " detached", sep = ""))
  }
}

detach_all_packages()

# this allows multiple persons to use the same RMarkdown
# without adjusting the working directory by themselves all the time
source("scripts/csf.R")
path_to_wd <- csf() # if this - for some reason - does not work,
# replace with a hardcoded path, like so: "~/projects/rddj-template/analysis/"
if ( is.null(path_to_wd) | !dir.exists(path_to_wd)) {
  print("WARNING: No working directory specified for current user")
} else {
  setwd(path_to_wd)
}

# suppress scientific notation
options(scipen = 999)

# unload global rstudioapi and knitr again to avoid conflicts with checkpoint
# this is only necessary if executed within RStudio
# outside of RStudio, namely in the knit.sh script, this causes RMarkdown
# rendering to fail, thus should not be executed there
if (Sys.getenv("RSTUDIO") == "1"){
  detach_all_packages()
}
```


### Packages definieren

```{r define packages}
# von https://mran.revolutionanalytics.com/web/packages/checkpoint/vignettes/using-checkpoint-with-knitr.html
# alle Packages, die nicht gebraucht werden, 
# können hier entfernt werden (auskommentieren reicht nicht!)
# Wichtig: wenn neues Package installiert werden soll, 
# scanForPackages = T setzen im checkpoint() call im nächsten Chunk
cat("
library(rstudioapi)
library(tidyverse) # ggplot2, dplyr, tidyr, readr, purrr, tibble
library(glue) # cooler string templating
library(magrittr) # pipes
library(scales) # scales for ggplot2
library(jsonlite) # json
library(lintr) # code linting, auf keinen Fall entfernen ;-)
library(styler) # code formatting
library(googlesheets) # googlesheets (replace with tidyverse/googlesheets4 asap)
library(rmarkdown) # muss für automatisches knitting
# in deploy.sh eingebunden werden",
file = "manifest.R")
```

### Packages installieren

```{r install packages}
# if checkpoint is not yet installed, install it (for people using this
# system for the first time)
if (!require(checkpoint)) {
  if (!require(devtools)) {
    install.packages("devtools", repos = "http://cran.us.r-project.org")
    require(devtools)
  }
  devtools::install_github("RevolutionAnalytics/checkpoint",
                           ref = "v0.3.2", # could be adapted later,
                           # as of now (beginning of July 2017
                           # this is the current release on CRAN)
                           repos = "http://cran.us.r-project.org")
  require(checkpoint)
}
# nolint start
if (!dir.exists("~/.checkpoint")) {
  dir.create("~/.checkpoint")
}
# nolint end
# install packages for the specified CRAN snapshot date
checkpoint(snapshotDate = package_date,
           project = path_to_wd,
           verbose = T,
           scanForPackages = T,
           use.knitr = F,
           R.version = R_version)
rm(package_date)
```


### Packages laden

```{r load packages, message=FALSE}
source("manifest.R")
unlink("manifest.R")
sessionInfo()
```

## Datenvorbereitung

``` {r read excel files 2017, message=FALSE}

glossar_2017 <- read_csv("input/gesundheitsbefragung_glossar_2017.csv")

# create new function that tries to read spreadsheet but returns NA if not present
read_if_exists <- possibly(readxl::read_excel, data.frame())

# map over all rows of the glossar
data_2017 <- glossar_2017 %>%
  pmap_dfr(function(filename, category, answers, comment) {
    # map through all these years and try to read the corresponding sheet
    c("1992", "1997", "2002", "2007", "2012", "2017") %>%
      map_df(function(year) {
        spreadsheet <- read_if_exists(
          glue("input/tabellen_2017/su-d-14.02-ESS-{filename}_CH.xlsx"),
          sheet = year,
          col_names = FALSE
        )
        if (nrow(spreadsheet) > 0) {
          # read topic from second row, first cell
          topic <- unlist(spreadsheet[2, 1])
          # rename columns
          column_names <- str_split(answers, ", ", simplify = TRUE)
          colnames(spreadsheet) <- c("group", "subgroup", column_names)
          # drop columns at end which have name NA
          spreadsheet <- spreadsheet[, 1:(length(column_names) + 2)]
          # return
          result <- spreadsheet %>%
            fill(group) %>%
            filter() %>%
            filter(
              !is.na(subgroup),
              !str_detect(group, "^Alter$|^Geschlecht$"),
              subgroup != "Gesamtbevölkerung"
            ) %>%
            # add column to indicate question asked
            mutate(
              category = category,
              topic = topic,
              filename = filename,
              year = as.numeric(year)
            ) %>%
            gather(
              key,
              value,
              -one_of(
                "n",
                "group",
                "subgroup",
                "filename",
                "year",
                "category",
                "topic")
              )
            }
      })
    })

# answers from less than 30 people are not considered statistically reliable
data_2017 %<>%
  filter(!str_detect(key, "_se$")) %>%
  filter(key != "n_percent" & key != "total_population") %>%
  mutate(
    value = as.numeric(value),
    year = as.numeric(year),
    n = as.numeric(n),
    too_few_values = (n * (value / 100)) < 30
  )

# output years found
knitr::kable(
  data_2017 %>%
    # keep only unique values for year and topic
    distinct(year, topic) %>%
    # sort years
    arrange(year) %>%
    group_by(topic) %>%
    # make one long string concatenated by commas for years
    summarise(year = paste(year, collapse = ", "))
)

```

```{r select data}

# data from 2017
categories_2017 <- unique(data_2017$category)

selected_data_2017 <- data_2017 %>%
  filter(category %in% categories_2017)

# Make variables for selected data
smoke <- selected_data_2017 %>%
  filter(category == "smoke")

smoke_amount <- selected_data_2017 %>%
  filter(category == "smoke_amount")

body_bmi <- selected_data_2017 %>%
  filter(category == "body_bmi")

drink_alcohol <- selected_data_2017 %>%
  filter(category == "drink_alcohol")

risk_alcohol <- selected_data_2017 %>%
  filter(category == "risk_alcohol")

binge_alcohol <- selected_data_2017 %>%
  filter(category == "binge_alcohol")

drugs_hard <- selected_data_2017 %>%
  filter(category == "drugs_hard")

drugs_soft <- selected_data_2017 %>%
  filter(category == "drugs_soft")

bloodpressure <- selected_data_2017 %>%
  filter(category == "bloodpressure")

activity <- selected_data_2017 %>%
  filter(category == "activity")

problems_body <- selected_data_2017 %>%
  filter(category == "problems_body")

eat_meat <- selected_data_2017 %>%
  filter(category == "eat_meat")

medicament_use <- selected_data_2017 %>%
  filter(category == "medicament_use")

problems_sleep <- selected_data_2017 %>%
  filter(category == "problems_sleep")

birth_control <- selected_data_2017 %>%
  filter(category == "birth_control")

```


``` {r functions to create plots}

# function to create area charts with factors in the right order, used for 2017 data
create_areachart_with_factors <- function(topic, age, factors, title) {
  ggplot(
  topic %>%
    filter(
      subgroup == age
    ) %>%
    mutate(
      key = factor(
        key,
        levels = factors
      )
    ),
  aes(
    x = year,
    y = value,
    fill = key
  )
) +
  geom_area() +
  facet_wrap(c("group"), ncol = 2) +
  scale_fill_brewer(palette = "Set1") +
  theme_minimal() +
  labs(
    title = paste0(title, age, "en")
  )
}

# function to create bar charts without factors, used for 2017 data
create_barchart_2017 <- function(topic, age, title) {
  ggplot(
  topic %>%
    filter(
      subgroup == age
    ),
  aes(
    x = year,
    y = value,
    fill = key,
    label = percent(value / 100)
  )
) +
  geom_bar(stat = "identity") +
  geom_text(
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 3
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(c("group", "subgroup"), ncol = 2) +
  theme_minimal() +
  labs(
    title = paste0(title, age, "e")
  )
}

# function to create bar charts with factors in the right order, used for 2017 data
create_barchart_with_factors_2017 <- function(topic, age, factors, title) {
  ggplot(
  topic %>%
    filter(
      subgroup == age
    ) %>%
    mutate(
      key = factor(
        key,
        levels = factors
      )
    ),
  aes(
    x = year,
    y = value,
    fill = key,
    label = percent(value / 100)
  )
) +
  geom_bar(stat = "identity") +
  geom_text(
    position = position_stack(vjust = 0.5),
    color = "white",
    size = 3
  ) +
  scale_fill_brewer(palette = "Set1") +
  facet_wrap(c("group", "subgroup"), ncol = 2) +
  theme_minimal() +
  labs(
    title = paste0(title, age, "e")
  )
}

```


```{r function to extract values for description}

# function to extract data from a specific topic, key and group, used for 2017 data
value_to_be_extracted <- function(topic, age, selected_key, selected_group) {
  topic %>%
    filter(
      subgroup == age,
      group == selected_group,
      key == selected_key
    )
}

```


```{r analysis 15-24-jährig}

age <- "15-24-jährig"

# adipositas
# nolint start
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value
adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(drink_alcohol, age, "everyday", "Männer")

alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(drink_alcohol, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value

```

## Visual Analysis
Für die visuelle Analyse wurden je nach Altersgruppe unterschiedliche Themen ausgewählt. Die Analysen sind nach Altersgruppe gegliedert.

### 15-24-Jährige
Für diese Altersgruppe wurden die Themen BMI, Rauchen, Alkohol, Fleisch-, harter Drogenkonsum und körperliche Aktivität ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert.

Der Anteil Raucher bleibt stabil. Die Gruppe der täglichen Alkoholkonsumenten wurde bei den Männern deutlich kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017.

Der tägliche Fleischkonsum  nimmt bei den Männern leicht ab. Ausserdem sind die Männer trainierter. Der Anteil Personen, die noch nie harte Drogen genommemn haben wir kleiner.


``` {r visual analysis 15-24}

age <- "15-24-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(drugs_hard, age, "Konsum harter Drogen bei ")

create_barchart_with_factors_2017(drugs_soft, age, c(
  "last_30_days",
  "last_12",
  "longer",
  "never"),
  "Konsum Drogen (inkl. Cannabis) bei "
  )

```

``` {r analysis generation 25-34}
age <- "25-34-jährig"

#adipositas
# nolint start
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value

#drugs
drugs_men <- value_to_be_extracted(drugs_hard, age, "never", "Männer")
drugs_men_1997 <- drugs_men[drugs_men$year == "1997", ]$value
drugs_men_2017 <- drugs_men[drugs_men$year == "2017", ]$value
drugs_women <- value_to_be_extracted(drugs_hard, age, "never", "Frauen")
drugs_women_1997 <- drugs_women[drugs_women$year == "1997", ]$value
drugs_women_2017 <- drugs_women[drugs_women$year == "2017", ]$value

#meat
meat_women <- value_to_be_extracted(eat_meat, age, "never", "Frauen")
meat_women_1997 <- meat_women[meat_women$year == "1992", ]$value
meat_women_2017 <- meat_women[meat_women$year == "2017", ]$value

```

### 25-34-Jährige
Für diese Altersgruppe wurden die Themen BMI, Rauchen und Anzahl Zigaretten, Alkohol, Fleisch-, harter Drogenkonsum und körperliche Aktivität ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Der Anteil untergewichtiger Frauen hat abgenommen. Der Anteil Frauen, die nie Fleisch essen, hat zugenommen um `r round((meat_women_2017 - meat_women_1997), digits=1)` Prozentpunkte.

Der Anteil Raucher bleibt stabil. Raucher konsumieren aber weniger Zigratten. Die Gruppe der täglichen Alkoholkonsumenten wurde bei den Männern deutlich kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017.

Der Konsum harter Drogen nimmt bei Frauen und Männern zu. Im Jahr 1997 hatten `r round(100 - drugs_women_1997, digits=1)` Prozent der befragten Frauen bereits einaml in ihrem Leben harte Dorgen konusmiert, 2017 waren es `r round(100 - drugs_women_2017, digits=1)` Prozent. Bei den Männern waren es 2017 `r round(100 - drugs_men_2017, digits=1)` Prozent.


``` {r visual analysis 25-34}

age <- "25-34-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(drugs_hard, age, "Konsum harter Drogen bei ")

create_barchart_with_factors_2017(drugs_soft, age, c(
  "last_30_days",
  "last_12",
  "longer",
  "never"),
  "Konsum Drogen (inkl. Cannabis) bei "
  )


```


``` {r analysis generation 35-44}
age <- "35-44-jährig"

#adipositas
# nolint start
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value

#drugs
drugs_men <- value_to_be_extracted(drugs_hard, age, "never", "Männer")
drugs_men_1997 <- drugs_men[drugs_men$year == "1997", ]$value
drugs_men_2017 <- drugs_men[drugs_men$year == "2017", ]$value

```

### 35-44-Jährige
Für diese Altersgruppe wurden die Themen BMI, Rauchen und Anzahl Zigaretten, Alkohol, Fleisch-, harter Drogenkonsum und körperliche Aktivität und Beschwerden ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Der Anteil untergewichtiger Frauen wurde kleiner. Der intensive Fleischkonsum nimmt ab. Der Anteil der inaktiven Personen wird immer kleiner.

Der Anteil Raucher bleibt stabil. Raucher konsumieren aber weniger Zigratten. Die Gruppe der täglichen Alkoholkonsumenten wurde bei den Männern deutlich kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017. Auch der Anteil der täglich alkoholtrinkenden Frauen ist geschrumpft: `r round((alk_women_1992 - alk_women_2017), digits=1)`

Der Konsum harter Drogen nimmt bei den Männern zu. Im Jahr 1997 hatten `r round(100 - drugs_men_1997, digits=1)` Prozent bereits einaml in ihrem Leben harte Dorgen konusmiert, 2017 waren es `r round(100 - drugs_men_2017, digits=1)` Prozent.

```{r visual analysis 35-44}

age <- "35-44-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der ")

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(drugs_hard, age, "Konsum harter Drogen bei ")

create_barchart_with_factors_2017(drugs_soft, age, c(
  "last_30_days",
  "last_12",
  "longer",
  "never"),
  "Konsum Drogen (inkl. Cannabis) bei ")

create_barchart_2017(problems_body, age, "Körperliche Beschwerden bei ")

```
``` {r analysis generation 45-54}
age <- "45-54-jährig"

#adipositas
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
# nolint start
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value
# nolint end

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
# nolint start
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value

```

### 45-54-Jährige
Für diese Altersgruppe wurden die Themen BMI, Rauchen und Anzahl Zigaretten, Alkohol, Fleisch-, körperliche Aktivität und Beschwerden ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Der Anteil untergewichtiger Frauen hat abgenommen. Fleisch wird weniger häufig gegessen.

Im Jahr 2017 war diese Generation aktiver, körperliche Beschwerden haben leicht abgenommen.

Der Anteil Raucher bleibt stabil. Raucher konsumieren aber weniger Zigratten. Die Gruppe der täglichen Alkoholkonsumenten wurde bei den Männern deutlich kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017. Auch der Anteil der täglich alkoholtrinkenden Frauen ist geschrumpft: `r round((alk_women_1992 - alk_women_2017), digits=1)`


```{r visual analysis 45-54}

age <- "45-54-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(drugs_hard, age, "Konsum harter Drogen bei ")

create_barchart_with_factors_2017(drugs_soft, age, c(
  "last_30_days",
  "last_12",
  "longer",
  "never"),
  "Konsum Drogen (inkl. Cannabis) bei "
  )

create_barchart_2017(problems_body, age, "Körperliche Beschwerden bei ")
# nolint start
create_barchart_2017(medicament_use, age,
                     "Haben Sie in den letzten 7 Tagen ein Medikament genommen? ")
# nolint end

```

``` {r analysis generation 55-64}
age <- "55-64-jährig"

#adipositas
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
# nolint start
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value
# nolint end

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
# nolint start
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
# nolint start
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value
# nolint end
```

### 55-64-Jährige
Für diese Altersgruppe wurden die Themen BMI, Alkohol und Fleischkonsum, Medikamentenkonsum, Schlafprobleme, körperliche Aktivität und Beschwerden ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Fleisch wird weniger häufig gegessen.

Im Jahr 2017 war diese Generation aktiver, körperliche Beschwerden sind gleich ausgesprägt geblieben. Mässige Schlafprobleme haben abgenommen, pathologische Schlafprobleme haben bei den Frauen zugenommen. Männer konsumieren mehr Medikamente.

Die Gruppe der täglichen Alkoholkonsumenten wurde bei den Männern deutlich kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017. Auch der Anteil der täglich alkoholtrinkenden Frauen ist geschrumpft: minus `r round((alk_women_2017- alk_women_1992), digits=1)` Prozentpunkte.


```{r visual analysis 55-64}

age <- "55-64-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(drugs_hard, age, "Konsum harter Drogen bei ")

create_barchart_with_factors_2017(drugs_soft, age, c(
  "last_30_days",
  "last_12",
  "longer",
  "never"),
  "Konsum Drogen (inkl. Cannabis) bei "
  )

create_barchart_2017(problems_body, age, "Körperliche Beschwerden bei ")

# nolint start
create_barchart_2017(medicament_use, age, "Haben Sie in den letzten 7 Tagen ein Medikament genommen? ")

create_barchart_with_factors_2017(problems_sleep, age, c(
  "none_light",
  "medium",
  "pathological"),
  "Schlafprobleme bei "
  )
# nolint end
```
``` {r analysis generation 65-74}
age <- "65-74-jährig"

#adipositas
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
adipositas_men_1992 <- adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <- adipositas_men[adipositas_men$year == "2017", ]$value

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
# nolint start
adipositas_women_1992 <- adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <- adipositas_women[adipositas_women$year == "2017", ]$value
# nolint end

#drink alcohol
alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992", ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017", ]$value

```

### 65-74-Jährige
Für diese Altersgruppe wurden die Themen BMI, Alkohol-, Fleisch- und Medikamentenkonsum, Bluthochdruck, Schlafprobleme, körperliche Aktivität und Beschwerden ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Fleisch wird weniger häufig gegessen.

Im Jahr 2017 war diese Generation aktiver, körperliche Beschwerden wurden etwas weniger. Schlafprobleme haben abgenommen. Männer konsumieren mehr Medikamente. Die Anzahl Personen mit Bluthochdruck nimmt leicht ab.

Die Gruppe der Alkoholabstinenten Männer wurde kleiner, von `r alk_men_1992` Prozent im Jahr 1992 auf `r alk_men_2017` Prozent 2017. Auch der Anteil der abstinenten Frauen ist geschrumpft: minus `r round((alk_women_2017 - alk_women_1992), digits=1)` Prozentpunkte.


```{r visual analysis 65-74}

age <- "65-74-jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der "
  )

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der "
  )

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der ")

create_barchart_2017(problems_body, age, "Körperliche Beschwerden bei ")

# nolint start
create_barchart_2017(medicament_use, age, "Haben Sie in den letzten 7 Tagen ein Medikament genommen? ")

create_barchart_with_factors_2017(problems_sleep, age, c(
  "none_light",
  "medium",
  "pathological"),
  "Schlafprobleme bei "
  )

#nolint end

create_barchart_2017(bloodpressure, age, "Hoher Blutdruck bei ")

```

``` {r analysis generation 75+}
age <- "75+ -jährig"
# nolint start
adipositas_men <- value_to_be_extracted(body_bmi, age, "adipositas", "Männer")
adipositas_men_1992 <-adipositas_men[adipositas_men$year == "1992", ]$value
adipositas_men_2017 <-adipositas_men[adipositas_men$year == "2017", ]$value

adipositas_women <- value_to_be_extracted(body_bmi, age, "adipositas", "Frauen")
adipositas_women_1992 <-adipositas_women[adipositas_women$year == "1992", ]$value
adipositas_women_2017 <-adipositas_women[adipositas_women$year == "2017", ]$value

alk_men <- value_to_be_extracted(body_bmi, age, "everyday", "Männer")
alk_men_1992 <- alk_men[alk_men$year == "1992", ]$value
alk_men_2017 <- alk_men[alk_men$year == "2017", ]$value

alk_women <- value_to_be_extracted(body_bmi, age, "everyday", "Frauen")
alk_women_1992 <- alk_women[alk_women$year == "1992" , ]$value
alk_women_2017 <- alk_women[alk_women$year == "2017" , ]$value
# nolint end

```

### 75+ -Jährige
Für diese Altersgruppe wurden die Themen BMI, Alkohol-, Fleisch- und Medikamentenkonsum, Bluthochdruck, Schlafprobleme, körperliche Aktivität und Beschwerden ausgewählt.

Der Anteil der adipösen Männer nahm um `r round((adipositas_men_2017 - adipositas_men_1992), digits=1)` Prozentpunkte zu. Bei den Frauen hat sich der Anteil um `r round((adipositas_women_2017 - adipositas_women_1992), digits=1)` Prozentpunkte vergrössert. Fleisch wird weniger häufig gegessen.

Im Jahr 2017 war diese Generation aktiver. Schlafprobleme haben bei den Frauen abgenommen. Männer und Frauen konsumieren mehr Medikamente als noch 1992. Bluthochdruck nimmt bei Frauen leicht zu, bei den Männern ab.

Die Gruppe der Alkoholabstinenten Frauen wurde kleiner, von `r alk_women_1992` Prozent im Jahr 1992 auf `r alk_women_2017` Prozent 2017.


```{r visual analysis 75+}

age <- "75+ -jährig"

create_barchart_with_factors_2017(body_bmi, age, c(
  "adipositas",
  "overweight",
  "normalweight",
  "underweight"),
  "BMI / Gewicht der "
  )

create_barchart_with_factors_2017(smoke, age, c(
  "no_smoker",
  "former_smoker",
  "smoker"),
  "Raucher "
  )

create_barchart_with_factors_2017(smoke_amount, age, c(
  "no_smoker",
  "less_1_cigarette_day",
  "1_9_cigarettes_day",
  "10_19_cigarettes_day",
  "20_plus_cigarettes_day"),
  "Anzahl Zigaretten "
  )

create_barchart_with_factors_2017(drink_alcohol, age, c(
  "never",
  "less_1_time_week",
  "1_2_times_week",
  "3_6_times_week",
  "everyday"),
  "Alkoholkonsum der ")

create_barchart_with_factors_2017(binge_alcohol, age, c(
  "once_month",
  "less_1_month",
  "never",
  "abstinent"),
  "Binge-Drinking der "
  )

create_barchart_with_factors_2017(risk_alcohol, age, c(
  "high",
  "low",
  "no_alk"),
  "Risikoreicher Alkoholkonsum der ")

create_barchart_with_factors_2017(activity, age, c(
  "not_active",
  "semi_active",
  "active",
  "trained"),
  "Körperliche Aktivität der "
  )

create_barchart_with_factors_2017(eat_meat, age, c(
  "everyday",
  "5_6_times_week",
  "4_times_week",
  "1_3_week",
  "less"),
  "Fleischkonsum der "
  )

create_barchart_2017(problems_body, age, "Körperliche Beschwerden bei ")

create_barchart_2017(medicament_use, age,
  "Haben Sie in den letzten 7 Tagen ein Medikament genommen? "
  )

create_barchart_with_factors_2017(problems_sleep, age, c(
  "none_light",
  "medium",
  "pathological"),
  "Schlafprobleme bei "
  )

create_barchart_2017(bloodpressure, age, "Hoher Blutdruck bei ")

```

## Export

Hier werden die CSV- und die JSON-Datei geschrieben, welche im Kapitel [Datenbeschreibung](#datenbeschreibung) genauer spezifiziert werden.


``` {r export to json and csv}

# regrouping meat
regrouping_meat <- selected_data_2017 %>%
  filter(category == "eat_meat") %>%
  mutate(key = ifelse(key %in% c(
    "1_3_week",
    "less"),
    "below_3", "above_3")) %>%
  group_by_at(vars(-value, -too_few_values)) %>%
  summarise(value = sum(value))

# regrouping drugs
regrouping_drugs <- selected_data_2017 %>%
  filter(category == "drugs_hard") %>%
  mutate(key = ifelse(key %in% c("last_12", "longer"), "once", "never")) %>%
  group_by_at(vars(-value, -too_few_values)) %>%
  summarise(value = sum(value))

# regrouping cannabis
regrouping_cannabis <- selected_data_2017 %>%
  filter(category == "cannabis") %>%
  mutate(key = ifelse(key %in% c(
    "last_30_days",
    "last_12",
    "longer"),
    "cannabis_smoked", "never")) %>%
  group_by_at(vars(-value, -too_few_values)) %>%
  summarise(value = sum(value))

# regrouping smoke: former smokers -> non smokers
regrouping_smoke <- selected_data_2017 %>%
  filter(category == "smoke") %>%
  mutate(key = ifelse(key %in% c("former_smoker"), "no_smoker", key)) %>%
  group_by_at(vars(-value, -too_few_values)) %>%
  summarise(value = sum(value))

# remove meat data and append new one
selected_data_2017 %<>%
  filter(!category %in% c("eat_meat", "drugs_hard", "cannabis", "smoke")) %>%
  bind_rows(regrouping_meat) %>%
  bind_rows(regrouping_drugs) %>%
  bind_rows(regrouping_cannabis) %>%
  bind_rows(regrouping_smoke)

# clean up
rm(
  regrouping_meat,
  regrouping_drugs,
  regrouping_cannabis,
  regrouping_smoke
)

selected_data_2017 %<>% mutate(
    subgroup = str_replace_all(subgroup, "\\+ -", "+-")
  )

write_csv(
  selected_data_2017 %>%
  filter(
    category %in% categories_2017,
    group == "Männer" | group == "Frauen",
    str_detect(subgroup, "jährig$")
    ) %>%
    select(group, subgroup, category, year, key, value) %>%
    mutate(value = value / 100),
    "output/health_survey_2017.csv"
)

# select data for interactive, only categories where a chart is displayed
categories_export_interactive <- c(
  "smoke",
  "activity",
  "problems_sleep",
  "body_bmi",
  "bloodpressure",
  "drugs_hard",
  "problems_body",
  "drink_alcohol",
  "cannabis",
  "medicament_use",
  "eat_meat"
  )

write_json(
  selected_data_2017 %>%
  filter(
    category %in% categories_export_interactive,
    group == "Männer" | group == "Frauen",
    str_detect(subgroup, "jährig$")
    ) %>%
    select(group, subgroup, category, year, key, value) %>%
    mutate(value = value / 100),
    "output/health_survey_2017.json"
)

```

## Linting

Der Code in diesem RMarkdown wird mit [lintr](https://github.com/jimhester/lintr) automatisch auf den Wickham'schen [tidyverse style guide](http://style.tidyverse.org/) überprüft. 


```{r echo=TRUE, message=FALSE, warning=FALSE}
lintr::lint("main.Rmd")
```